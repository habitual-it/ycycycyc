name: Build Android Agent

on:
  push:
    branches: [ main, master ]
    paths:
      - "android-agent/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle  # 启用Gradle缓存，加速构建
      
      - name: CI环境诊断
        run: |
          echo "=== Java版本信息 ==="
          java -version || true
          echo -e "\n=== Gradle版本信息 ==="
          if [ -f android-agent/gradlew ]; then
            android-agent/gradlew -v || true
          else
            gradle -v || true
          fi
          echo -e "\n=== 系统环境变量 ==="
          env | grep -E "JAVA|GRADLE|OS" | sort
      
      - name: 清理macOS专属Gradle配置（关键修复）
        working-directory: android-agent
        run: |
          # 清理gradle.properties中的无效参数
          if [ -f gradle.properties ]; then
            echo "清理前的gradle.properties内容："
            cat gradle.properties
            sed -i '/-Xdock:name=Gradle/d' gradle.properties
            sed -i '/JAVA_OPTS.*Xdock/d' gradle.properties
            sed -i '/org.gradle.jvmargs.*Xdock/d' gradle.properties
            echo -e "\n清理后的gradle.properties内容："
            cat gradle.properties
          fi
          
          # 清理gradle wrapper配置
          if [ -f gradle/wrapper/gradle-wrapper.properties ]; then
            sed -i '/-Xdock:name=Gradle/d' gradle/wrapper/gradle-wrapper.properties
          fi
          
          # 清理gradlew脚本中的无效参数
          if [ -f gradlew ]; then
            sed -i '/-Xdock:name=Gradle/d' gradlew
          fi
      
      - name: 确保gradlew可执行
        working-directory: android-agent
        run: chmod +x ./gradlew || true
      
      - name: 生成Wrapper（若缺失）并构建APK
        working-directory: android-agent
        run: |
          # 若没有gradlew，自动安装Gradle并生成Wrapper
          if [ ! -f ./gradlew ]; then
            sudo apt-get update
            sudo apt-get install -y gradle
            gradle wrapper --gradle-version 8.6
            chmod +x ./gradlew
          fi
          
          # 显式指定兼容的JVM参数（避免macOS配置）
          ./gradlew assembleDebug \
            --stacktrace \
            --info \
            -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" \
            -Dorg.gradle.parallel=true \
            -Dorg.gradle.daemon=false
      
      - name: 上传Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: RemoteAgent-debug-apk
          path: android-agent/app/build/outputs/apk/debug/*.apk
          retention-days: 7  # 保留7天，节省存储空间
      
      - name: 构建失败时上传日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: |
            android-agent/app/build/reports/
            android-agent/build/reports/
            android-agent/app/build/outputs/
            android-agent/gradle.properties
          retention-days: 7