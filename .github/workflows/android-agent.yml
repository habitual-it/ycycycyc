name: Build Android Agent

on:
  push:
    branches: [ main, master ]
    paths:
      - "android-agent/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      
      - name: CI环境诊断
        run: |
          echo "=== Java版本信息 ==="
          java -version || true
          echo -e "\n=== Gradle版本信息 ==="
          if [ -f android-agent/gradlew ]; then
            android-agent/gradlew -v || true
          else
            gradle -v || true
          fi
          echo -e "\n=== 系统环境变量 ==="
          env | grep -E "JAVA|GRADLE|OS" | sort
      
      - name: 终极清理 - 全文件扫描删除-Xdock参数（关键修复）
        working-directory: android-agent
        run: |
          echo "=== 开始扫描并清理所有文件中的-Xdock:name=Gradle ==="
          
          # 1. 扫描并删除所有类型文件中的目标参数
          # 覆盖：properties/gradlew/gradle/sh/bat等所有可能文件
          find . -type f \( \
            -name "*.properties" -o \
            -name "gradlew" -o \
            -name "gradlew.bat" -o \
            -name "*.gradle" -o \
            -name "*.gradle.kts" -o \
            -name "*.sh" -o \
            -name "*.bat" \
          \) -exec sed -i '/-Xdock:name=Gradle/d' {} +
          
          # 2. 单独处理gradlew脚本（避免编码问题）
          if [ -f gradlew ]; then
            sed -i 's/-Xdock:name=Gradle//g' gradlew
            chmod +x gradlew
          fi
          
          # 3. 验证清理结果
          echo -e "\n=== 清理后验证（若下方无输出则清理成功）==="
          grep -r "-Xdock:name=Gradle" . || echo "✅ 所有-Xdock参数已彻底清理"
      
      - name: 确保gradlew可执行
        working-directory: android-agent
        run: chmod +x ./gradlew || true
      
      - name: 生成Wrapper（若缺失）并构建APK
        working-directory: android-agent
        run: |
          # 若没有gradlew，自动安装Gradle并生成Wrapper
          if [ ! -f ./gradlew ]; then
            sudo apt-get update
            sudo apt-get install -y gradle
            gradle wrapper --gradle-version 8.6
            chmod +x ./gradlew
          fi
          
          # 显式指定安全的JVM参数，彻底避开无效配置
          ./gradlew assembleDebug \
            --stacktrace \
            --info \
            -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" \
            -Dorg.gradle.parallel=true \
            -Dorg.gradle.daemon=false
      
      - name: 上传Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: RemoteAgent-debug-apk
          path: android-agent/app/build/outputs/apk/debug/*.apk
          retention-days: 7
      
      - name: 构建失败时上传日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: |
            android-agent/**/*.log
            android-agent/**/*.properties
            android-agent/gradlew
            android-agent/app/build/reports/
          retention-days: 7