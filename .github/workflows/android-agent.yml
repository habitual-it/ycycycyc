name: Build Android Agent

on:
  push:
    branches: [ main, master ]
    paths:
      - "android-agent/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: CI环境诊断
        run: |
          echo "=== Java版本信息 ==="
          java -version || true
          echo -e "\n=== Gradle版本信息 ==="
          if [ -f android-agent/gradlew ]; then
            android-agent/gradlew -v || true
          else
            gradle -v || true
          fi
          echo -e "\n=== 系统环境变量 ==="
          env | grep -E "JAVA|GRADLE|OS" | sort
      
      - name: 生成Wrapper并构建APK（带详细日志）
        working-directory: android-agent
        run: |
          # 生成Gradle Wrapper
          gradle wrapper --gradle-version 8.6 --info || true
          
          # 确保gradlew可执行
          chmod +x ./gradlew
          
          # 构建APK，添加详细日志和堆栈跟踪
          ./gradlew assembleDebug --info --stacktrace
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: RemoteAgent-debug-apk
          path: android-agent/app/build/outputs/apk/debug/*.apk
